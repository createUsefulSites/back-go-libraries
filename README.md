# Приложение онлайн-библиотеки

Приложение онлайн-библиотеки! Это RESTful API, разработанное на Go с использованием фреймворка Gin и ORM GORM для работы с базой данных PostgreSQL. Приложение позволяет пользователям управлять книгами, брать их, возвращать и оставлять отзывы, а также предоставляет администраторам возможность добавлять и удалять книги.

## Возможности

- Регистрация и вход пользователей с ролевым доступом (админ/пользователь).
- Получение списка всех книг с авторами и жанрами (GET /books).
- Добавление новой книги (POST /books) — только для админов.
- Удаление книги (DELETE /books/:id) — только для админов.
- Взять книгу (POST /books/:id/borrow).
- Вернуть книгу (POST /books/:id/return).
- Добавить отзыв на книгу (POST /books/:id/review).

## Требования

- Go (версия 1.20 или выше)
- PostgreSQL (версия 9.6 или выше)
- Git

## Установка

1. **Клонируйте репозиторий**:

2. **Инициализируйте Go-модуль**:
   ```bash
   go mod init library-app
   go mod tidy
   ```

3. **Установите зависимости**:
   ```bash
   go get github.com/gin-gonic/gin
   go get gorm.io/gorm
   go get gorm.io/driver/postgres
   go get github.com/joho/godotenv
   go get github.com/dgrijalva/jwt-go
   ```

4. **Настройте PostgreSQL**:
   - Убедитесь, что PostgreSQL запущен:
     ```bash
     sudo systemctl start postgresql
     ```
   - прогнать миграции ```go run migrator/main.go```

5. **Настройте переменные окружения**:
   - Создайте файл `.env` в корневой директории проекта со следующим содержимым:
     ```
     DB_URL=host=localhost port=5432 user=youruser password=yourpass dbname=library sslmode=disable
     ```
   - Замените `youruser`, `yourpass` и, при необходимости, настройте `host` и `port`.

## Заполнение базы данных тестовыми данными

Чтобы заполнить базу данных тестовыми данными (пользователи, жанры, авторы, книги, заказы и отзывы), выполните следующий SQL-скрипт:

1. Сохраните скрипт ниже в файл `seed.sql`.
2. Выполните его с помощью `psql`:
   ```bash
   psql -h localhost -U youruser -d library -f seed.sql
   ```

```sql
-- Вставка пользователей
INSERT INTO users (name, email, password_hash, role, registration_date, status) VALUES
('Админ', 'admin@example.com', 'hashedpassword1', 'admin', '2025-05-01 10:00:00', 'active'),
('Иван Иванов', 'ivan.ivanov@example.com', 'hashedpassword2', 'user', '2025-05-10 12:00:00', 'active'),
('Мария Петрова', 'maria.petrova@example.com', 'hashedpassword3', 'user', '2025-05-15 14:00:00', 'active');

-- Вставка жанров
INSERT INTO genres (name, description) VALUES
('Фэнтези', 'Книги с магией и мифическими существами'),
('Научная фантастика', 'Книги о футуристических концепциях и технологиях');

-- Вставка авторов
INSERT INTO authors (name, birth_year, country, biography) VALUES
('Дж. Р. Р. Толкин', 1892, 'Великобритания', 'Автор "Властелина колец"'),
('Айзек Азимов', 1920, 'США', 'Автор серии "Основание"'),
('Урсула К. Ле Гуин', 1929, 'США', 'Автор серии "Земноморье"');

-- Вставка книг
INSERT INTO books (title, description, publication_year, isbn, genre_id, total_copies, available_copies, cover_url, added_date) VALUES
('Хоббит', 'Фэнтезийное приключение о Бильбо Бэггинсе', 1937, '9780261102217', 1, 5, 3, 'http://example.com/hobbit.jpg', '2025-05-20 09:00:00'),
('Основание', 'Научно-фантастический эпос о падении империи', 1951, '9780553293357', 2, 4, 2, 'http://example.com/foundation.jpg', '2025-05-21 10:00:00'),
('Волшебник Земноморья', 'Фэнтезийная история о юном волшебнике', 1968, '9780547773742', 1, 3, 1, 'http://example.com/earthsea.jpg', '2025-05-22 11:00:00'),
('Левая рука тьмы', 'Научно-фантастическое исследование гендера', 1969, '9780441478125', 2, 2, 1, 'http://example.com/left_hand.jpg', '2025-05-23 12:00:00');

-- Вставка связей книга-автор
INSERT INTO book_authors (book_id, author_id) VALUES
(1, 1), -- Хоббит -> Дж. Р. Р. Толкин
(2, 2), -- Основание -> Айзек Азимов
(3, 3), -- Волшебник Земноморья -> Урсула К. Ле Гуин
(4, 3), -- Левая рука тьмы -> Урсула К. Ле Гуин
(1, 3); -- Хоббит -> Урсула К. Ле Гуин (пример соавторства)

-- Вставка заказов
INSERT INTO orders (user_id, book_id, order_date, due_date, return_date, status) VALUES
(2, 1, '2025-05-21 15:00:00', '2025-06-04 15:00:00', '2025-05-28 15:00:00', 'returned'), -- Иван Иванов вернул Хоббит
(2, 2, '2025-05-22 16:00:00', '2025-06-05 16:00:00', NULL, 'issued'), -- Иван Иванов взял Основание
(3, 3, '2025-05-23 17:00:00', '2025-06-06 17:00:00', '2025-05-27 17:00:00', 'returned'), -- Мария Петрова вернула Волшебник Земноморья
(3, 4, '2025-05-24 18:00:00', '2025-06-07 18:00:00', NULL, 'issued'); -- Мария Петрова взяла Левая рука тьмы

-- Вставка отзывов
INSERT INTO reviews (user_id, book_id, rating, comment, created_at) VALUES
(2, 1, 5, 'Потрясающее приключение!', '2025-05-28 15:30:00'), -- Иван Иванов о Хоббите
(3, 3, 4, 'Отличная история взросления.', '2025-05-27 17:30:00'), -- Мария Петрова о Волшебнике Земноморья
(2, 1, 4, 'Очень понравилась эта книга.', '2025-05-28 16:00:00'), -- Иван Иванов ещё один отзыв о Хоббите
(3, 3, 5, 'Понравилась магическая система!', '2025-05-27 18:00:00'); -- Мария Петрова ещё один отзыв о Волшебнике Земноморья
```

## Запуск приложения

1. Убедитесь, что PostgreSQL запущен и база данных настроена.
2. Запустите приложение:
   ```bash
   go run main.go
   ```
   Сервер запустится на `localhost:8080`.

## Использование API

### Аутентификация
- **Регистрация**: `POST /register`
- **Вход**: `POST /login`

После входа вы получите JWT-токен, который нужно передавать в заголовке `Authorization` в формате `Bearer <token>`.

### Основные эндпоинты
- **Получить список книг**: `GET /books`
  - Пример ответа:
    ```json
    [
        {
            "id": 1,
            "title": "Хоббит",
            "description": "Фэнтезийное приключение о Бильбо Бэггинсе",
            "publication_year": 1937,
            "isbn": "9780261102217",
            "genre": "Фэнтези",
            "total_copies": 5,
            "available_copies": 3,
            "cover_url": "http://example.com/hobbit.jpg",
            "added_date": "2025-05-20T09:00:00Z",
            "authors": ["Дж. Р. Р. Толкин", "Урсула К. Ле Гуин"]
        }
    ]
    ```

- **Добавить книгу (админ)**: `POST /books`
  - Тело запроса:
    ```json
    {
        "title": "Новая книга",
        "isbn": "1234567890123",
        "genre_id": 1,
        "total_copies": 10,
        "author_ids": [1, 2]
    }
    ```

- **Удалить книгу (админ)**: `DELETE /books/:id`

- **Взять книгу**: `POST /books/:id/borrow`

- **Вернуть книгу**: `POST /books/:id/return`

- **Добавить отзыв**: `POST /books/:id/review`
  - Тело запроса:
    ```json
    {
        "rating": 5,
        "comment": "Отличная книга!"
    }
    ```

## Дополнительные замечания

- **Секретный ключ JWT**: В `middleware/auth.go` замените `"your-secret-key"` на ваш секретный ключ для подписи токенов.
- **Логирование**: Для отладки включите режим отладки GORM в `database/database.go`:
  ```go
  DB, err = gorm.Open(postgres.Open(dsn), &gorm.Config{
      Logger: logger.Default.LogMode(logger.Info),
  })
  ```
